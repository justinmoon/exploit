# Notes: if you screw this up and need to start over:
# rm -rf ~/.bitcoin/regtest/wallets/segwit-bug
# Don't attempt this if you have real bitcoin balance in bitcoind / bitcoin-qt

# Assumptions
# - one device, unlocked
# - default wallet has > 35 BTC settled balance

# make aliases work in this script
shopt -s expand_aliases

## stop regtest if it's running
#bitcoin-cli -regtest stop

## sleep one second to wait for bitcoind to stop
#sleep 1

## wipe out regtest folder
#rm -rf ~/.bitcoin/regtest/

## start regtest
#bitcoind -regtest > /dev/null

# sleep one second to wait for bitcoind to start
#sleep 1

## set bitcoin-cli aliases
alias bcli_default="bitcoin-cli -regtest -rpcwallet=''"
alias bcli_trezor="bitcoin-cli -regtest -rpcwallet='segwit-bug'"

# Generate some blocks to default wallet
bcli_default generatetoaddress 150 $(bcli_default getnewaddress)

# create wallet
bitcoin-cli -regtest createwallet segwit-bug true

# grab fingerprint (requires unlocked trezor, only one device plugged in)
FINGERPRINT=$(hwi enumerate | jq -r .[0].fingerprint)

# alias hwi to testnet with this fingerprint
alias hwitt="hwi --testnet --fingerprint $FINGERPRINT"

# get segwit receive descriptor
DESC=$(hwitt getdescriptors | jq -r .receive[2])
echo $DESC

# export addresses to watch-only wallet
bcli_trezor importmulti '''[{"desc":"'$DESC'","watchonly":true,"range":[0,100],"timestamp":"now"}]'''

# this fails for some reason
addrs=$(bcli_trezor deriveaddresses $DESC [0,1])
addr_15=$(echo $addrs | jq -r .[0])
addr_20=$(echo $addrs | jq -r .[1])
echo $addr_15
echo $addr_20

# fund these addresses
bcli_default sendtoaddress $addr_15 15
bcli_default sendtoaddress $addr_20 20
bcli_default generatetoaddress 1 $(bcli_default getnewaddress)

# print balances
echo $(bcli_trezor getbalances)
