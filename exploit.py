from bitcoinrpc.authproxy import AuthServiceProxy, JSONRPCException
from hwilib import commands
from hwilib.devices import coldcard, ledger, trezor

# Setup rpc client
rpc_user = "u"
rpc_password = "p"
rpc_wallet_name = "segwit-bug"
default_rpc = AuthServiceProxy("http://%s:%s@127.0.0.1:18443/wallet/"%(rpc_user, rpc_password))
wallet_rpc = AuthServiceProxy("http://%s:%s@127.0.0.1:18443/wallet/%s"%(rpc_user, rpc_password, rpc_wallet_name))

def get_hwi_client():
    '''create hwi client for plugged-in hardware wallet'''
    # list devices
    devices = commands.enumerate()

    # make sure there is only one
    assert len(devices) == 1, "One hardware wallet must be plugged in"

    # make sure it's unlocked
    device = devices[0]
    fingerprint = device.get("fingerprint")
    assert fingerprint is not None, f"Your ${device.type} is locked"

    # return client that can address this device
    if device['type'] == 'ledger':
        client = ledger.LedgerClient(device['path'])
    elif device['type'] == 'coldcard':
        client = coldcard.ColdcardClient(device['path'])
    elif device['type'] == 'trezor':
        client = trezor.TrezorClient(device['path'])
    else:
        raise Exception(f"Couldn't create client for you \"${device.type}\" device")
    
    # set HWI to testnet
    client.is_testnet = True

    return client

def prepare():
    '''create watch-only bitcoin core wallet to use with trezor'''
    # generate address on default rpc wallet
    default_address = default_rpc.getnewaddress()
    print(default_address)

    # generate 150 block to this address (so we have some coins to play with)
    default_rpc.generatetoaddress(150, default_address)
    
    # create or load watch-only wallet to use with our trezor
    ensure_watchonly_wallet()

def load_wallet():
    try:
        default_rpc.loadwallet(rpc_wallet_name)
        return True
    except JSONRPCException as e:
        if e.message == f"Wallet {rpc_wallet_name} not found.":
            return False
        else:
            raise(e)  # propogate any other error

def ensure_watchonly_wallet():
    # check if this rpc wallet is already loaded
    loaded_rpc_wallets = default_rpc.listwallets()
    if rpc_wallet_name in loaded_rpc_wallets:
        print("Wallet already loaded")
        return

    # attempt to load this wallet in case it already exists
    if load_wallet():
        print("Wallet loaded")
        return

    # wallet doesn't exist yet, create it
    create_wallet_response = default_rpc.createwallet(rpc_wallet_name, True)
    if create_wallet_response["warning"] != "":
        raise Exception("Failed to create watch-only wallet")
    else:
        print("Wallet created")

def derive_address(descriptor, index):
    result = wallet_rpc.deriveaddresses(descriptor, [index, index])
    return result[0]

def get_p2wpkh_descriptor():
    hwi_client = get_hwi_client()
    all_descriptors = commands.getdescriptors(hwi_client)
    receive_descriptors = all_descriptors["receive"]
    receive_p2wpkh_descriptor_index = 2
    receive_p2wpkh_descriptor = receive_descriptors[receive_p2wpkh_descriptor_index]
    return receive_p2wpkh_descriptor


def main():
    prepare()

    # get p2wpkh descriptor from our hww
    descriptor = get_p2wpkh_descriptor()

    # create and fund addresses with amounts matching trezor write-up
    addr_15 = derive_address(descriptor, 0)
    addr_20 = derive_address(descriptor, 1)

    print(addr_15)
    print(addr_20)

main()
