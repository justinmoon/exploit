from bitcoinrpc.authproxy import AuthServiceProxy, JSONRPCException
from hwilib import commands
from hwilib.devices import coldcard, ledger, trezor

# Setup rpc client
rpc_user = "u"
rpc_password = "p"
rpc_wallet_name = "segwit-bug"
default_rpc = AuthServiceProxy("http://%s:%s@127.0.0.1:18443"%(rpc_user, rpc_password))
wallet_rpc = AuthServiceProxy("http://%s:%s@127.0.0.1:18443/wallets/%s"%(rpc_user, rpc_password, rpc_wallet_name))

def get_client():
    '''create hwi client for plugged-in hardware wallet'''
    # list devices
    devices = commands.enumerate()

    # make sure there is only one
    assert len(devices) == 1, "One hardware wallet must be plugged in"

    # make sure it's unlocked
    device = devices[0]
    fingerprint = device.get("fingerprint")
    assert fingerprint is not None, f"Your ${device.type} is locked"

    # return client that can address this device
    if device['type'] == 'ledger':
        client = ledger.LedgerClient(device['path'])
    elif device['type'] == 'coldcard':
        client = coldcard.ColdcardClient(device['path'])
    elif device['type'] == 'trezor':
        client = trezor.TrezorClient(device['path'])
    else:
        raise Exception(f"Couldn't create client for you \"${device.type}\" device")
    
    return client

